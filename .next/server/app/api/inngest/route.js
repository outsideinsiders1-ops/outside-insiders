"use strict";(()=>{var a={};a.id=730,a.ids=[730],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{a.exports=require("punycode")},16698:a=>{a.exports=require("node:async_hooks")},21820:a=>{a.exports=require("os")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67923:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>aj,patchFetch:()=>ai,routeModule:()=>ae,serverHooks:()=>ah,workAsyncStorage:()=>af,workUnitAsyncStorage:()=>ag});var d={};c.r(d),c.d(d,{GET:()=>ab,POST:()=>ac,PUT:()=>ad});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(91658),v=c(54863),w=c(85887),x=c(31761),y=c(67486),z=c(45067),A=c(36650),B=c(68164),C=c(3907),D=c(16897),E=c(43066),F=c(91363);c(51526);var G=class{timings={};start(a,b){this.timings[a]||(this.timings[a]={description:b??"",timers:[]});let c=this.timings[a].timers.push({start:Date.now()})-1;return()=>{let b=this.timings[a];if(!b)return console.warn(`Timing "${a}" does not exist`);let d=b.timers[c];if(!d)return console.warn(`Timer ${c} for timing "${a}" does not exist`);d.end=Date.now()}}append(a,b){this.timings[a]={description:b,timers:[]}}async wrap(a,b,c){let d=this.start(a,c);try{return await (0,F.VH)(b)}finally{d()}}getHeader(){return Object.entries(this.timings).reduce((a,[b,{description:c,timers:d}])=>{if(!d.some(a=>a.end))return a;let e=d.reduce((a,{start:b,end:c})=>b&&c?a+(c-b):a,0);return[...a,[b,c?`desc="${c}"`:"",e?`dur=${e}`:""].filter(Boolean).join(";")]},[]).join(", ")}},H=c(93855),I=c(64908),J=c(11223);function K(a){let b=Error(a);return b.source="ulid",b}let L="0123456789ABCDEFGHJKMNPQRSTVWXYZ",M=L.length,N=function(a){return a||(a=function(a=!1,b){b||(b="undefined"!=typeof window?window:null);let d=b&&(b.crypto||b.msCrypto);if(d)return()=>{let a=new Uint8Array(1);return d.getRandomValues(a),a[0]/255};try{let a=c(55511);return()=>a.randomBytes(1).readUInt8()/255}catch(a){}if(a){try{console.error("secure crypto unusable, falling back to insecure Math.random()!")}catch(a){}return()=>Math.random()}throw K("secure crypto unusable, insecure Math.random not allowed")}()),function(b){return isNaN(b)&&(b=Date.now()),function(a,b){let c;if(isNaN(a))throw Error(a+" must be a number");if(a>0xffffffffffff)throw K("cannot encode time greater than 281474976710655");if(a<0)throw K("time must be positive");if(!1===Number.isInteger(Number(a)))throw K("time must be an integer");let d="";for(;b>0;b--)c=a%M,d=L.charAt(c)+d,a=(a-c)/M;return d}(b,10)+function(a,b){let c="";for(;a>0;a--)c=function(a){let b=Math.floor(a()*M);return b===M&&(b=M-1),L.charAt(b)}(b)+c;return c}(16,a)}}();var O=c(2995);let P=O.Ik({status:O.ai().default(200),skipped:O.zM().optional().default(!1),modified:O.zM().optional().default(!1),error:O.Yj().default("Successfully registered")});var Q=class{id;handler;inngestRegisterUrl;frameworkName;signingKey;signingKeyFallback;_mode;fetch;_serveHost;_servePath;logLevel;streaming;rawFns;client;fns={};env=(0,u.Kg)();allowExpiredSignatures;_options;skipSignatureValidation;constructor(a){if(this._options=a,Object.hasOwn(a,"eventKey"))throw Error(`${x.JY} You've passed an Inngest client as the first argument to your serve handler. This is no longer supported in v3; please pass the Inngest client as the \`client\` property of an options object instead. See https://www.inngest.com/docs/sdk/migration`);this.frameworkName=a.frameworkName,this.client=a.client,a.id&&console.warn(`${x.JY} The \`id\` serve option is deprecated and will be removed in v4`),this.id=a.id||this.client.id,this.handler=a.handler,this.allowExpiredSignatures=!!arguments[0]?.__testingAllowExpiredSignatures,this.rawFns=a.functions?.filter(Boolean)??[],this.rawFns.length!==(a.functions??[]).length&&console.warn("Some functions passed to serve() are undefined and misconfigured.  Please check your imports."),this.fns=this.rawFns.reduce((a,b)=>{let c=b.getConfig({baseUrl:new URL("https://example.com"),appPrefix:this.id}),d=c.reduce((a,{id:c},d)=>({...a,[c]:{fn:b,onFailure:!!d}}),{});return c.forEach(({id:b})=>{if(a[b])throw Error(`Duplicate function ID "${b}"; please change a function's name or provide an explicit ID to avoid conflicts.`)}),{...a,...d}},{}),this.inngestRegisterUrl=new URL("/fn/register",this.apiBaseUrl),this.signingKey=a.signingKey,this.signingKeyFallback=a.signingKeyFallback,this._serveHost=a.serveHost||this.env[x.yu.InngestServeHost],this._servePath=a.servePath||this.env[x.yu.InngestServePath],this.skipSignatureValidation=a.skipSignatureValidation||!1;let b="info";this.logLevel=O.k5(y._H).default(b).catch(a=>(this.log("warn",`Unknown log level passed: ${String(a.input)}; defaulting to ${b}`),b)).parse(a.logLevel||this.env[x.yu.InngestLogLevel]),"debug"===this.logLevel&&J.enable&&"function"==typeof J.enable&&J.enable(`${x.cF}:*`),this.streaming=O.KC([O.k5(["allow","force"]),O.eu(!1)]).default(!1).catch(a=>(this.log("warn",`Unknown streaming option passed: ${String(a.input)}; defaulting to ${String(!1)}`),!1)).parse(a.streaming||this.env[x.yu.InngestStreaming]),this.fetch=a.fetch?(0,u.J4)(a.fetch):this.client.fetch}get apiBaseUrl(){return this._options.baseUrl||this.env[x.yu.InngestApiBaseUrl]||this.env[x.yu.InngestBaseUrl]||this.client.apiBaseUrl||x.q8}get eventApiBaseUrl(){return this._options.baseUrl||this.env[x.yu.InngestEventApiBaseUrl]||this.env[x.yu.InngestBaseUrl]||this.client.eventBaseUrl||x.i4}get serveHost(){return this._serveHost||this.env[x.yu.InngestServeHost]}get servePath(){return this._servePath||this.env[x.yu.InngestServePath]}get hashedEventKey(){if(this.client.eventKey&&this.client.eventKey!==x.Ud)return(0,C.EC)(this.client.eventKey)}get hashedSigningKey(){if(this.signingKey)return(0,C.N9)(this.signingKey)}get hashedSigningKeyFallback(){if(this.signingKeyFallback)return(0,C.N9)(this.signingKeyFallback)}async shouldStream(a){return await a.queryStringWithDefaults("testing for probe",x.lH.Probe)===void 0&&!!a.transformStreamingResponse&&("force"===this.streaming||"allow"===this.streaming&&(0,u.CJ)(this.frameworkName,this.env))}async isInngestReq(a){let b="checking if this is an Inngest request",[c,d]=await Promise.all([a.headers(b,x.Mb.InngestRunId),a.headers(b,x.Mb.Signature)]);return!!(c&&"string"==typeof d)}async initRequest(...a){let b=new G,c=await this.getActions(b,...a),[d,e]=await Promise.all([c.env?.("starting to handle request"),c.headers("checking expected server kind",x.Mb.InngestServerKind)]);this.env={...(0,u.Kg)(),...d};let f=Promise.all(x.T2.map(async a=>({header:a,value:await c.headers(`fetching ${a} for forwarding`,a)}))).then(a=>a.reduce((a,{header:b,value:c})=>(c&&(a[b]=c),a),{})),g=async()=>({...(0,u.NT)({env:this.env,framework:this.frameworkName,client:this.client,expectedServerKind:e||void 0,extras:{"Server-Timing":b.getHeader()}}),...await f}),h=(0,u.Wi)({env:this.env,client:this.client});if(h.isExplicit)this._mode=h;else{let a=await c.isProduction?.("starting to handle request");"boolean"==typeof a?this._mode=new u.Kt({type:a?"cloud":"dev",isExplicit:!1}):this._mode=h}return this.upsertKeysFromEnv(),{timer:b,actions:c,getHeaders:g}}createSyncHandler(){return a=>this.wrapHandler(async(...b)=>{let c=await this.initRequest(...b),d=new H.P(this.client,{id:this._options.syncOptions?.functionId??"",retries:this._options.syncOptions?.retries??x.u7},()=>a(...b));return await this.isInngestReq(c.actions)?this.handleAsyncRequest({...c,forceExecution:!0,args:b,fns:[d]}):this.handleSyncRequest({...c,args:b,asyncMode:this._options.syncOptions?.asyncResponse??y.wr.Redirect,fn:d})})}createHandler(){return this.wrapHandler(async(...a)=>this.handleAsyncRequest({...await this.initRequest(...a),args:a}))}async createHttpEvent(a,b){let c="creating sync event",d=a.headers(c,x.Mb.ContentType).then(a=>a??""),e=a.headers(c,x.Mb.ForwardedFor).then(b=>b||a.headers(c,x.Mb.RealIp).then(a=>a??"")),f=a.method(c),g=a.url(c).then(a=>this.reqUrl(a)),h=g.then(a=>`${a.protocol}//${a.host}`),i=g.then(a=>a.pathname),j=g.then(a=>a.searchParams.toString()),k=a.textBody(c).then(a=>"string"==typeof a?a:(0,C.As)(a)),[l,m,n,o,p,q,r]=await Promise.all([d,h,e,f,i,j,k]);return{name:"http/run.started",data:{content_type:l,domain:m,ip:n,method:o,path:p,query_params:q,body:r,fn:b.id()}}}async handleSyncRequest({timer:a,actions:b,fn:c,asyncMode:d,args:e}){if(!b.experimentalTransformSyncResponse)throw Error("This platform does not support synchronous Inngest function executions.");if(await (0,v.E)())throw Error("We already seem to be in the context of an Inngest execution, but didn't expect to be. Did you already wrap this handler?");let f=N(),g=await this.createHttpEvent(b,c),h=z.SI,i=await c.createExecution({version:h,partialOptions:{client:this.client,data:{runId:f,event:g,attempt:0,events:[g],maxAttempts:c.opts.retries??x.u7},runId:f,headers:{},reqArgs:e,stepCompletionOrder:[],stepState:{},disableImmediateExecution:!1,isFailureHandler:!1,timer:a,createResponse:a=>b.experimentalTransformSyncResponse("creating sync execution",a).then(a=>({...a,version:h})),stepMode:y.CY.Sync}}).start(),j={"step-not-found":()=>{throw Error("We should not get the result 'step-not-found' when checkpointing. This is a bug in the `inngest` SDK")},"steps-found":()=>{throw Error("We should not get the result 'steps-found' when checkpointing. This is a bug in the `inngest` SDK")},"step-ran":()=>{throw Error("We should not get the result 'step-ran' when checkpointing. This is a bug in the `inngest` SDK")},"function-rejected":()=>{throw Error("We should not get the result 'function-rejected' when checkpointing. This is a bug in the `inngest` SDK")},"function-resolved":({data:a})=>a,"change-mode":async({token:a})=>{switch(d){case y.wr.Redirect:return b.transformResponse("creating sync->async redirect response",{status:302,headers:{[x.Mb.Location]:await this.client.inngestApi.getTargetUrl(`/v1/http/runs/${f}/output?token=${a}`).then(a=>a.toString())},version:h,body:""});case y.wr.Token:return b.transformResponse("creating sync->async token response",{status:200,headers:{},version:h,body:(0,C.As)({run_id:f,token:a})})}throw Error("Not implemented: change-mode")}}[i.type];if(!j)throw Error(`No handler for execution result type: ${i.type}. This is a bug in the \`inngest\` SDK`);return j(i)}async handleAsyncRequest({timer:a,actions:b,args:c,getHeaders:d,forceExecution:e,fns:f}){if(e&&!b.experimentalTransformSyncResponse)throw Error("This platform does not support async executions in Inngest for APIs.");let g=b.method("starting to handle request"),h=await b.headers("checking signature for request",x.Mb.ContentLength).then(a=>{if(a)return Number.parseInt(a,10)}),[i,j,k]=await Promise.all([b.headers("checking signature for request",x.Mb.Signature).then(a=>a??void 0),g,g.then(a=>"POST"===a||"PUT"===a?h?b.body(`checking body for request signing as method is ${a}`):"":"")]),l=this.validateSignature(i,k),m=a.wrap("action",()=>this.handleAction({actions:b,timer:a,getHeaders:d,reqArgs:c,signatureValidation:l,body:k,method:j,forceExecution:!!e,fns:f})),n=async a=>{let b,c={...await d(),...a.headers,...null===a.version?{}:{[x.Mb.RequestVersion]:(a.version??z.SI).toString()}};try{b=await l.then(b=>{if(b.success&&b.keyUsed)return this.getResponseSignature(b.keyUsed,a.body)})}catch(b){return{...a,headers:c,body:(0,C.As)((0,A.P5)(b)),status:500}}return b&&(c[x.Mb.Signature]=b),{...a,headers:c}};if(await this.shouldStream(b)&&await b.method("starting streaming response")==="POST"){let{stream:c,finalize:e}=await (a=>{let b,c=new Promise(a=>{b=a}),d=a?.interval??3e3,e=a?.value??" ";return new Promise(async(a,f)=>{try{a({stream:new ReadableStream({start(a){let c=new TextEncoder,f=setInterval(()=>{a.enqueue(c.encode(e))},d);b(b=>{clearInterval(f),Promise.resolve(b).then(b=>{a.enqueue(c.encode((0,C.As)(b))),a.close()})})}}),finalize:await c})}catch(a){f(a)}})})();return m.then(a=>e(n(a))),a.wrap("res",async()=>b.transformStreamingResponse?.("starting streaming response",{status:201,headers:await d(),body:c,version:null}))}return a.wrap("res",async()=>m.then(n).then(a=>b.transformResponse("sending back response",a)))}async getActions(a,...b){let c=b[b.length-1],d="object"==typeof c&&null!==c&&"actionOverrides"in c&&"object"==typeof c.actionOverrides&&null!==c.actionOverrides?c.actionOverrides:{},e={...Object.entries({...await a.wrap("handler",()=>this.handler(...b)).catch((0,A.G3)("Serve handler failed to run")),...d}).reduce((a,[b,c])=>"function"!=typeof c?a:{...a,[b]:(a,...d)=>{let e=[`Failed calling \`${b}\` from serve handler`,a].filter(Boolean).join(" when ");return(0,F.VH)(()=>c(...d)).catch((0,A.G3)(e)).catch(a=>{throw this.log("error",a),a})}},{}),queryStringWithDefaults:async(a,b)=>{let c=await e.url(a);return await e.queryString?.(a,b,c)||c.searchParams.get(b)||void 0},...d};return e}wrapHandler(a){return Object.defineProperties(a,{name:{value:"InngestHandler"},length:{value:this.handler.length}}),a}get mode(){return this._mode}set mode(a){this._mode=a,a&&(this.client.mode=a)}async handleAction({actions:a,timer:b,getHeaders:c,reqArgs:d,signatureValidation:e,body:f,method:g,forceExecution:h,fns:i}){let j=void 0===f,k=f;try{let f=await a.url("starting to handle request");if("POST"===g||h){let f,g,l;if(!h&&j)return this.log("error","Missing body when executing, possibly due to missing request body middleware"),{status:500,headers:{"Content-Type":"application/json"},body:(0,C.As)((0,A.P5)(Error("Missing request body when executing, possibly due to missing request body middleware"))),version:void 0};let m=await e;if(!m.success)return{status:401,headers:{"Content-Type":"application/json"},body:(0,C.As)((0,A.P5)(m.err)),version:void 0};if(h)f=i?.length&&i[0]?{fn:i[0],onFailure:!1}:Object.values(this.fns)[0],g=f?.fn.id(),l="step",k={event:{},events:[],steps:{},version:z.SI,ctx:{attempt:0,disable_immediate_execution:!1,use_api:!0,max_attempts:3,run_id:await a.headers("getting run ID for forced execution",x.Mb.InngestRunId),stack:{stack:[],current:0}}};else{let b=await a.queryStringWithDefaults("testing for probe",x.lH.Probe);if(b){let a=((a,b)=>{if(Object.values(a).includes(b))return b})(x.dy,b);if(!a)return{status:400,headers:{"Content-Type":"application/json"},body:(0,C.As)((0,A.P5)(Error(`Unknown probe "${b}"`))),version:void 0};return({[x.dy.Trust]:()=>({status:200,headers:{"Content-Type":"application/json"},body:"",version:void 0})})[a]()}if(!(g=await a.queryStringWithDefaults("processing run request",x.lH.FnId)))throw Error("No function ID found in async request");f=this.fns[g],l=await a.queryStringWithDefaults("processing run request",x.lH.StepId)||null}if(void 0===g||!f)throw Error("No function ID found in request");let{version:n,result:o}=this.runStep({functionId:g,data:k,stepId:l,timer:b,reqArgs:d,headers:await c(),fn:f,forceExecution:h,actions:a}),p=await o,q=a=>(a.data=(0,B.d$)(a.data),a),r={"function-rejected":a=>({status:a.retriable?500:400,headers:{"Content-Type":"application/json",[x.Mb.NoRetry]:a.retriable?"false":"true",..."string"==typeof a.retriable?{[x.Mb.RetryAfter]:a.retriable}:{}},body:(0,C.As)((0,B.d$)(a.error)),version:n}),"function-resolved":a=>{if(h){let b={id:I.wV.hashId("complete"),op:y.Hv.RunComplete,data:(0,B.d$)(a.data)};return{status:206,headers:{"Content-Type":"application/json"},body:(0,C.As)(b),version:n}}return{status:200,headers:{"Content-Type":"application/json"},body:(0,C.As)((0,B.d$)(a.data)),version:n}},"step-not-found":a=>({status:500,headers:{"Content-Type":"application/json",[x.Mb.NoRetry]:"false"},body:(0,C.As)({error:`Could not find step "${a.step.displayName||a.step.id}" to run; timed out`}),version:n}),"step-ran":a=>{let b=q(a.step);return{status:206,headers:{"Content-Type":"application/json",...void 0!==a.retriable?{[x.Mb.NoRetry]:a.retriable?"false":"true",..."string"==typeof a.retriable?{[x.Mb.RetryAfter]:a.retriable}:{}}:{}},body:(0,C.As)([b]),version:n}},"steps-found":a=>{let b=a.steps.map(q);return{status:206,headers:{"Content-Type":"application/json"},body:(0,C.As)(b),version:n}},"change-mode":a=>({status:500,headers:{"Content-Type":"application/json",[x.Mb.NoRetry]:"true"},body:(0,C.As)({error:`We wanted to change mode to "${a.to}", but this is not supported within the InngestCommHandler. This is a bug in the Inngest SDK.`}),version:n})}[p.type];try{return await r(p)}catch(a){throw this.log("error","Error handling execution result",a),a}}let l=(await c())[x.Mb.Environment]??null;if("GET"===g)return{status:200,body:(0,C.As)(await this.introspectionBody({actions:a,env:l,signatureValidation:e,url:f})),headers:{"Content-Type":"application/json"},version:void 0};if("PUT"===g){let[b,d]=await Promise.all([a.queryStringWithDefaults("processing deployment request",x.lH.DeployId).then(a=>"undefined"===a?void 0:a),Promise.resolve((0,u.cr)(this.env[x.yu.InngestAllowInBandSync])).then(b=>void 0===b||b?a.headers("processing deployment request",x.Mb.InngestSyncKind):x.ag.OutOfBand).then(a=>a===x.ag.InBand)]);if(d){if(j)return this.log("error","Missing body when syncing, possibly due to missing request body middleware"),{status:500,headers:{"Content-Type":"application/json"},body:(0,C.As)((0,A.P5)(Error("Missing request body when syncing, possibly due to missing request body middleware"))),version:void 0};if(!(await e).success)return{status:401,body:(0,C.As)({code:"sig_verification_failed"}),headers:{"Content-Type":"application/json"},version:void 0};let c=y.k5.safeParse(k);if(!c.success)return{status:400,body:(0,C.As)({code:"invalid_request",message:c.error.message}),headers:{"Content-Type":"application/json"},version:void 0};return f=this.reqUrl(new URL(c.data.url)),{status:200,body:(0,C.As)(await this.inBandRegisterBody({actions:a,deployId:b,env:l,signatureValidation:e,url:f})),headers:{"Content-Type":"application/json",[x.Mb.InngestSyncKind]:x.ag.InBand},version:void 0}}let{status:g,message:h,modified:i}=await this.register(this.reqUrl(f),b,c);return{status:g,body:(0,C.As)({message:h,modified:i}),headers:{"Content-Type":"application/json",[x.Mb.InngestSyncKind]:x.ag.OutOfBand},version:void 0}}}catch(a){return{status:500,body:(0,C.As)({type:"internal",...(0,A.P5)(a)}),headers:{"Content-Type":"application/json"},version:void 0}}return{status:405,body:JSON.stringify({message:"No action found; request was likely not POST, PUT, or GET",mode:this._mode}),headers:{},version:void 0}}runStep({actions:a,functionId:b,stepId:c,data:d,timer:e,reqArgs:f,headers:g,fn:h,forceExecution:i}){if(!h)throw Error(`Could not find function with ID "${b}"`);let j=(0,B.q8)(d),{version:k}=j;k===x.DK.V1&&h.fn.shouldOptimizeParallelism?.()&&(k=x.DK.V2);let l=(0,F.VH)(async()=>{let b=await (0,B.Gv)({data:j,api:this.client.inngestApi,version:k});if(!b.ok)throw Error(b.error);let d=i&&a.experimentalTransformSyncResponse?b=>a.experimentalTransformSyncResponse("created sync->async response",b).then(a=>({...a,version:k})):void 0,l=await ({[x.DK.V0]:({event:a,events:b,steps:i,ctx:j,version:k})=>{let l=Object.entries(i??{}).reduce((a,[b,c])=>({...a,[b]:{id:b,data:c}}),{});return{version:k,partialOptions:{client:this.client,runId:j?.run_id||"",stepMode:y.CY.Async,data:{event:a,events:b,runId:j?.run_id||"",attempt:j?.attempt??0},stepState:l,requestedRunStep:"step"===c?void 0:c||void 0,timer:e,isFailureHandler:h.onFailure,stepCompletionOrder:j?.stack?.stack??[],reqArgs:f,headers:g,createResponse:d}}},[x.DK.V1]:({event:a,events:b,steps:i,ctx:j,version:k})=>{let l=Object.entries(i??{}).reduce((a,[b,c])=>({...a,[b]:"data"===c.type?{id:b,data:c.data}:"input"===c.type?{id:b,input:c.input}:{id:b,error:c.error}}),{}),m="step"===c?void 0:c||void 0,n=h.fn.shouldAsyncCheckpoint(m,j?.fn_id,!!j?.disable_immediate_execution);return{version:k,partialOptions:{client:this.client,runId:j?.run_id||"",stepMode:n?y.CY.AsyncCheckpointing:y.CY.Async,checkpointingConfig:n,data:{event:a,events:b,runId:j?.run_id||"",attempt:j?.attempt??0,maxAttempts:j?.max_attempts},internalFnId:j?.fn_id,queueItemId:j?.qi_id,stepState:l,requestedRunStep:m,timer:e,isFailureHandler:h.onFailure,disableImmediateExecution:j?.disable_immediate_execution,stepCompletionOrder:j?.stack?.stack??[],reqArgs:f,headers:g,createResponse:d}}},[x.DK.V2]:({event:a,events:b,steps:i,ctx:j,version:k})=>{let l=Object.entries(i??{}).reduce((a,[b,c])=>({...a,[b]:"data"===c.type?{id:b,data:c.data}:"input"===c.type?{id:b,input:c.input}:{id:b,error:c.error}}),{}),m="step"===c?void 0:c||void 0,n=h.fn.shouldAsyncCheckpoint(m,j?.fn_id,!!j?.disable_immediate_execution);return{version:k,partialOptions:{client:this.client,runId:j?.run_id||"",stepMode:n?y.CY.AsyncCheckpointing:y.CY.Async,checkpointingConfig:n,data:{event:a,events:b,runId:j?.run_id||"",attempt:j?.attempt??0,maxAttempts:j?.max_attempts},internalFnId:j?.fn_id,queueItemId:j?.qi_id,stepState:l,requestedRunStep:m,timer:e,isFailureHandler:h.onFailure,disableImmediateExecution:j?.disable_immediate_execution,stepCompletionOrder:j?.stack?.stack??[],reqArgs:f,headers:g,createResponse:d}}}})[k](b.value);return h.fn.createExecution(l).start()});return{version:k,result:l}}configs(a){let b=Object.values(this.rawFns).reduce((b,c)=>[...b,...c.getConfig({baseUrl:a,appPrefix:this.id})],[]);for(let a of b){let b=y.IR.safeParse(a);if(!b.success){let c=b.error.errors.map(a=>a.message).join("; ");this.log("warn",`Config invalid for function "${a.id}" : ${c}`)}}return b}reqUrl(a){let b=new URL(a),c=this.serveHost||this.env[x.yu.InngestServeHost],d=this.servePath||this.env[x.yu.InngestServePath];return d&&(b.pathname=d),c&&(b=new URL(b.pathname+b.search,c)),b}registerBody({url:a,deployId:b}){return{url:a.href,deployType:"ping",framework:this.frameworkName,appName:this.id,functions:this.configs(a),sdk:`js:v${w.r}`,v:"0.1",deployId:b||void 0,capabilities:{trust_probe:"v1",connect:"v1"},appVersion:this.client.appVersion}}async inBandRegisterBody({actions:a,deployId:b,env:c,signatureValidation:d,url:e}){let f=this.registerBody({deployId:b,url:e}),g=await this.introspectionBody({actions:a,env:c,signatureValidation:d,url:e}),h={app_id:this.id,appVersion:this.client.appVersion,capabilities:f.capabilities,env:c,framework:f.framework,functions:f.functions,inspection:g,platform:(0,u.t1)({...(0,u.Kg)(),...this.env}),sdk_author:"inngest",sdk_language:"",sdk_version:"",sdk:f.sdk,url:f.url};return g.authentication_succeeded&&(h.sdk_language=g.sdk_language,h.sdk_version=g.sdk_version),h}async introspectionBody({actions:a,env:b,signatureValidation:c,url:d}){let e=this.registerBody({url:this.reqUrl(d),deployId:null});if(!this._mode)throw Error("No mode set; cannot introspect without mode");let f={authentication_succeeded:null,extra:{is_mode_explicit:this._mode.isExplicit},has_event_key:this.client.eventKeySet(),has_signing_key:!!this.signingKey,function_count:e.functions.length,mode:this._mode.type,schema_version:"2024-05-24"};if("cloud"===this._mode.type)try{if(!(await c).success)throw Error("Signature validation failed");f={...f,authentication_succeeded:!0,api_origin:this.apiBaseUrl,app_id:this.id,capabilities:{trust_probe:"v1",connect:"v1"},env:b,event_api_origin:this.eventApiBaseUrl,event_key_hash:this.hashedEventKey??null,extra:{...f.extra,is_streaming:await this.shouldStream(a)},framework:this.frameworkName,sdk_language:"js",sdk_version:w.r,serve_origin:this.serveHost??null,serve_path:this.servePath??null,signing_key_fallback_hash:this.hashedSigningKeyFallback??null,signing_key_hash:this.hashedSigningKey??null}}catch{f={...f,authentication_succeeded:!1}}return f}async register(a,b,c){let d,e,f,g,h,i=this.registerBody({url:a,deployId:b}),j=new URL(this.inngestRegisterUrl.href);if(this._mode&&this._mode.isInferred&&this._mode.isDev){let a=(0,u.P7)(this.env);await (0,D.W)(a,this.fetch)&&(j=(0,D.Q)(a,"/fn/register"))}else this._mode?.explicitDevUrl&&(j=(0,D.Q)(this._mode.explicitDevUrl.href,"/fn/register"));b&&j.searchParams.set(x.lH.DeployId,b);try{d=await (0,E.d)({authToken:this.hashedSigningKey,authTokenFallback:this.hashedSigningKeyFallback,fetch:this.fetch,url:j.href,options:{method:"POST",body:(0,C.As)(i),headers:{...await c(),[x.Mb.InngestSyncKind]:x.ag.OutOfBand},redirect:"follow"}})}catch(a){return this.log("error",a),{status:500,message:`Failed to register${a instanceof Error?`; ${a.message}`:""}`,modified:!1}}let k=await d.text(),l={};try{l=JSON.parse(k)}catch(b){this.log("warn","Couldn't unpack register response:",b);let a="Failed to register";return b instanceof Error&&(a+=`; ${b.message}`),{status:500,message:a+=`; status code: ${d.status}`,modified:!1}}try{({status:e,error:f,skipped:g,modified:h}=P.parse(l))}catch(b){this.log("warn","Invalid register response schema:",b);let a="Failed to register";return b instanceof Error&&(a+=`; ${b.message}`),{status:500,message:a+=`; status code: ${d.status}`,modified:!1}}return g||this.log("debug","registered inngest functions:",d.status,d.statusText,l),{status:e,message:f,modified:h}}upsertKeysFromEnv(){this.env[x.yu.InngestSigningKey]&&(this.signingKey||(this.signingKey=String(this.env[x.yu.InngestSigningKey])),this.client.inngestApi.setSigningKey(this.signingKey)),this.env[x.yu.InngestSigningKeyFallback]&&(this.signingKeyFallback||(this.signingKeyFallback=String(this.env[x.yu.InngestSigningKeyFallback])),this.client.inngestApi.setSigningKeyFallback(this.signingKeyFallback)),!this.client.eventKeySet()&&this.env[x.yu.InngestEventKey]&&this.client.setEventKey(String(this.env[x.yu.InngestEventKey])),this.env[x.yu.InngestDevServerUrl]&&this.log("warn",`Use of ${x.yu.InngestDevServerUrl} has been deprecated in v3; please use ${x.yu.InngestBaseUrl} instead. See https://www.inngest.com/docs/sdk/migration`)}async validateSignature(a,b){try{if(this.skipSignatureValidation||this._mode&&!this._mode.isCloud)return{success:!0,keyUsed:""};if(!this.signingKey)throw Error(`No signing key found in client options or ${x.yu.InngestSigningKey} env var. Find your keys at https://app.inngest.com/secrets`);if(!a)throw Error(`No ${x.Mb.Signature} provided`);return{success:!0,keyUsed:new R(a).verifySignature({body:b,allowExpiredSignatures:this.allowExpiredSignatures,signingKey:this.signingKey,signingKeyFallback:this.signingKeyFallback})}}catch(a){return{success:!1,err:a}}}getResponseSignature(a,b){let c=Date.now();return`t=${c}&s=${(0,E.l)(b,a,c.toString())}`}log(a,...b){let c=["debug","info","warn","error","fatal","silent"],d=c.indexOf(this.logLevel);if(c.indexOf(a)>=d){let c=console.log;Object.hasOwn(console,a)&&(c=console[a]),c(`${x.JY} ${a} -`,...b)}}},R=class{timestamp;signature;constructor(a){let b=new URLSearchParams(a);if(this.timestamp=b.get("t")||"",this.signature=b.get("s")||"",!this.timestamp||!this.signature)throw Error(`Invalid ${x.Mb.Signature} provided`)}hasExpired(a){return!a&&Date.now()-new Date(1e3*Number.parseInt(this.timestamp)).valueOf()>3e5}#a({body:a,signingKey:b,allowExpiredSignatures:c}){if(this.hasExpired(c))throw Error("Signature has expired");if((0,E.l)(a,b,this.timestamp)!==this.signature)throw Error("Invalid signature")}verifySignature({body:a,signingKey:b,signingKeyFallback:c,allowExpiredSignatures:d}){try{return this.#a({body:a,signingKey:b,allowExpiredSignatures:d}),b}catch(b){if(!c)throw b;return this.#a({body:a,signingKey:c,allowExpiredSignatures:d}),c}}},S=c(15959),T=c(52246),U=c(68113),V=c(3195),W=c(45456),X=c(78940),Y=c(96484);async function*Z(a,b,c,d,e,f,g={}){let h;console.log(`ðŸ“¥ Downloading file from storage: ${c}`);let{data:i,error:j}=await a.storage.from(b).download(c);if(j)throw Error(`Failed to download file from storage: ${j.message}`);let k=await i.arrayBuffer(),l=c.split("/").pop()||"unknown",m={name:l,arrayBuffer:async()=>k,type:l.toLowerCase().endsWith(".zip")?"application/zip":"application/octet-stream",size:k.byteLength};if(l.toLowerCase().endsWith(".zip")||l.toLowerCase().endsWith(".shp"))console.log("\uD83D\uDCE6 Parsing shapefile..."),h=await (0,T.h)(m);else if(l.toLowerCase().endsWith(".geojson")||l.toLowerCase().endsWith(".json"))console.log("\uD83D\uDCC4 Parsing GeoJSON..."),h=JSON.parse(new TextDecoder().decode(new Uint8Array(k)));else throw Error(`Unsupported file type: ${l}`);if(!h.type||!h.features)throw Error("Invalid GeoJSON format");console.log(`âœ… Parsed ${h.features.length} features from ${l}`);let n=h.features,{batchSize:o=500,simplifyTolerance:p=1e-4,skipInvalidGeometry:q=!0}=g,r=[],s=0;for(let a of n)try{let b=(0,U.G)(a.properties,d,e,f);if(a.geometry){let c=a.geometry;if(!(0,X.$U)(c).isValid){if(q){console.warn(`âš ï¸ Skipping invalid geometry for park: ${b.name}`);continue}c=(0,X.WC)(c)}p>0&&(c=(0,V.Mp)(c,p)),b.geometry=(0,W.B)(c)}b.state?b.state=(0,Y.NC)(b.state):f&&(b.state=(0,Y.NC)(f)),r.push(b),s++,r.length>=o&&(yield r,r=[])}catch(a){if(console.error(`Error processing feature: ${a.message}`),!q)throw a}r.length>0&&(yield r),console.log(`âœ… Processed ${s} features from ${l}`)}var $=c(53976),_=c(46931);let aa=S.V.createFunction({id:"process-park-file",name:"Process Park File",retries:3,concurrency:{limit:2,key:"event.data.filePath"}},{event:"file/process"},async({event:a,step:b})=>{let{filePath:c,bucketName:d="park-uploads",sourceType:e="State Agency",sourceName:f="Unknown",defaultState:g=null}=a.data;console.log(`ðŸš€ Starting background processing for: ${c}`);let h=await b.run("process-file",async()=>{let a=0,b=0,h=0,i=0,j=[];try{for await(let k of Z(_.w,d,c,e,f,g,{batchSize:500,simplifyTolerance:1e-4,skipInvalidGeometry:!0}))try{let c=await (0,$.BN)(k,e);a+=k.length,b+=c.added||0,h+=c.updated||0,i+=c.skipped||0,console.log(`ðŸ“Š Progress: ${a} processed (${b} added, ${h} updated, ${i} skipped)`)}catch(a){console.error(`âŒ Error processing batch:`,a),j.push({batch:k.length,error:a.message})}return{success:!0,totalProcessed:a,totalAdded:b,totalUpdated:h,totalSkipped:i,errors:j.length>0?j:void 0}}catch(c){return console.error(`âŒ Error processing file:`,c),{success:!1,error:c.message,totalProcessed:a,totalAdded:b,totalUpdated:h,totalSkipped:i,errors:j}}});return await b.run("update-status",async()=>(console.log(`âœ… Processing complete for ${c}:`,h),h)),h}),{GET:ab,POST:ac,PUT:ad}=(a=>{let b=new Q({frameworkName:"nextjs",...a,handler:(b,...c)=>{let[d,e]=c,f=a=>{let b="function"==typeof d.headers.get?d.headers.get(a):d.headers[a];return Array.isArray(b)?b[0]:b};return{body:()=>"function"==typeof d.json?d.json():d.body,headers:f,method:()=>b||d.method||"",isProduction:()=>{try{return!0}catch(a){}},queryString:(a,b)=>{let c=d.query?.[a]||b.searchParams.get(a);return Array.isArray(c)?c[0]:c},url:()=>{let b;try{b=new URL(d.url)}catch{}if(b){let c=a.serveHost||f("host");if(c){let a=new URL(c.includes("://")?c:`${b.protocol}//${c}`);b.protocol=a.protocol,b.host=a.host,b.port=a.port,b.username=a.username,b.password=a.password}return b}let c=a.serveHost||f("host")||"";return new URL(d.url,`https://${c}`)},transformResponse:({body:a,headers:b,status:c})=>{if((a=>(a=>"object"==typeof a&&null!==a)(a)&&"function"==typeof a.setHeader&&"function"==typeof a.status&&"function"==typeof a.send)(e)){for(let[a,c]of Object.entries(b))e.setHeader(a,c);e.status(c),e.send(a);return}return new((0,u.mi)())(a,{status:c,headers:b})},transformStreamingResponse:({body:a,headers:b,status:c})=>new Response(a,{status:c,headers:b})}}}).createHandler(),c=b.bind(null,void 0);return Object.defineProperty(c,"length",{value:1}),Object.defineProperties(c,{GET:{value:b.bind(null,"GET")},POST:{value:b.bind(null,"POST")},PUT:{value:b.bind(null,"PUT")}})})({client:S.V,functions:[aa]}),ae=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/inngest/route",pathname:"/api/inngest",filename:"route",bundlePath:"app/api/inngest/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/robertfleming/outside-insiders-current/app/api/inngest/route.js",nextConfigOutput:"",userland:d}),{workAsyncStorage:af,workUnitAsyncStorage:ag,serverHooks:ah}=ae;function ai(){return(0,g.patchFetch)({workAsyncStorage:af,workUnitAsyncStorage:ag})}async function aj(a,b,c){var d;let e="/api/inngest/route";"/index"===e&&(e="/");let g=await ae.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||ae.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===ae.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),L={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>ae.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},M=new k.NodeNextRequest(a),N=new k.NodeNextResponse(b),O=l.NextRequestAdapter.fromNodeNextRequest(M,(0,l.signalFromNodeResponse)(b));try{let d=async c=>ae.handle(O,L).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=L.renderOpts.collectedTags;if(!E)return await (0,o.I)(M,N,e,L.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,d=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await ae.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await ae.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(M,N,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await ae.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(M,N,new Response(null,{status:500})),null}}},74075:a=>{a.exports=require("zlib")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},83997:a=>{a.exports=require("tty")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{a.exports=require("events")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[873,505,729,708,702],()=>b(b.s=67923));module.exports=c})();